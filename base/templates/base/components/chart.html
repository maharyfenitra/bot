<style>
    /* Style the chart container */
    #chart-container {
        width: 100%;
        height: 70vh;
        margin: 0 auto;
    }
</style>
<!-- Container for the chart -->
<div id="chart-container"></div>
    
<div class="row mb-3">
    <!-- Dropdown menu for selecting timeframes -->
    <div class="col">
        <label for="timeframe">Select Timeframe:</label>
        <select id="timeframe" class="form-control">
            <option value="1m">1 Minute</option>
            <option value="5m">5 Minutes</option>
            <option value="15m">15 Minutes</option>
            <option value="30m">30 Minutes</option>
            <option value="1h">1 Hour</option>
            <option value="4h">4 Hours</option>
            <option value="1d">1 Day</option>
            <option value="1w">1 Week</option>
            <option value="1M">1 Month</option>
        </select>
    </div>

    <!-- Dropdown menu for selecting time units -->
    <div class="col">
        <label for="timeunit">Select Time Unit:</label>
        <select id="timeunit" class="form-control">
            <option value="day">Day</option>
            <option value="week">Week</option>
            <option value="month">Month</option>
            <option value="hour">Hour</option>
            <option value="minute">Minute</option>
        </select>
    </div>
</div>



<!-- Script to fetch historical data from Binance REST API -->
<script>
    // Create a new chart
    const chart = LightweightCharts.createChart(document.getElementById('chart-container'), {
        width: document.getElementById('chart-container').offsetWidth, // Set chart width to container width
        height: document.getElementById('chart-container').offsetHeight, // Set chart height to container height
        layout: {
            backgroundColor: '#f0f4f8', // Set background color
        },
        priceScale: {
            borderColor: '#d1d4dc', // Set border color for price scale
        },
        timeScale: {
            borderColor: '#d1d4dc', // Set border color for time scale
        },
    });

    // Add a candlestick series to the chart
    const candleSeries = chart.addCandlestickSeries();

    // Function to fetch historical data for the selected timeframe
    function fetchHistoricalData(timeframe) {
        fetch(`https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=${timeframe}&limit=1000`)
            .then(response => response.json())
            .then(data => {
                // Format historical data for the chart
                const formattedData = data.map(item => ({
                    time: item[0] / 1000, // Convert timestamp to seconds
                    open: parseFloat(item[1]),
                    high: parseFloat(item[2]),
                    low: parseFloat(item[3]),
                    close: parseFloat(item[4]),
                }));
                // Update the chart with historical data
                candleSeries.setData(formattedData);
            })
            .catch(error => {
                console.error('Error fetching historical data:', error);
            });
    }

    // Initial fetch for 1-minute timeframe
    fetchHistoricalData('1m');

    // Open a WebSocket connection to Binance
    const ws = new WebSocket('wss://stream.binance.com:9443/ws/btcusdt@kline_1m');

    // Handle messages received from the WebSocket
    ws.onmessage = function (event) {
        const message = JSON.parse(event.data);
        const candle = {
            time: message.k.t / 1000, // Convert timestamp to seconds
            open: parseFloat(message.k.o),
            high: parseFloat(message.k.h),
            low: parseFloat(message.k.l),
            close: parseFloat(message.k.c),
        };
        candleSeries.update(candle); // Update the chart with the new candlestick
    };

    // Event listener for timeframe selection
    document.getElementById('timeframe').addEventListener('change', function() {
        const selectedTimeframe = this.value;
        fetchHistoricalData(selectedTimeframe); // Fetch historical data for the selected timeframe
    });

    // Event listener for timeunit selection
    document.getElementById('timeunit').addEventListener('change', function() {
        const selectedTimeUnit = this.value;
        chart.timeScale().applyOptions({ timeVisible: true, secondsVisible: false, tickMarkFormatter: timeUnitFormatter(selectedTimeUnit) }); // Set the time scale options based on the selected time unit
    });

    // Function to format time unit for time scale
    function timeUnitFormatter(selectedTimeUnit) {
        return (timestamp) => {
            const date = new Date(timestamp * 1000);
            switch (selectedTimeUnit) {
                case 'day':
                    return date.toLocaleDateString();
                case 'week':
                    // Customize week format as needed
                    return 'Week ' + getWeekNumber(date);
                case 'month':
                    return date.toLocaleString('default', { month: 'long' });
                case 'hour':
                    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                case 'minute':
                    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                default:
                    return '';
            }
        };
    }

    // Function to get week number
    function getWeekNumber(date) {
        const oneJan = new Date(date.getFullYear(), 0, 1);
        const dayOfYear = Math.floor((date - oneJan) / 86400000);
        const weekNumber = Math.ceil((dayOfYear + oneJan.getDay() + 1) / 7);
        return weekNumber;
    }
</script>